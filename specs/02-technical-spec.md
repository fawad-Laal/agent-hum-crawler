# Technical Spec - Dynamic Monitoring Agent

Date: 2026-02-17
Version: 0.1 (MVP)

## 1. Architecture Overview
Components:
- Intake layer: collects runtime config from user.
- Monitoring layer: gathers and normalizes online updates.
- Intelligence layer: severity/confidence classification + dedupe/change detection.
- Alert layer: formats and posts Moltis chat alerts.
- State layer: stores cycle state (hashes, timestamps, prior summaries).

## 2. Runtime Configuration Model

```json
{
  "countries": ["Pakistan", "Bangladesh"],
  "disaster_types": ["cyclone/storm", "flood", "earthquake"],
  "check_interval_minutes": 30,
  "subregions": {
    "Pakistan": ["Sindh"]
  },
  "priority_sources": [],
  "quiet_hours_local": null
}
```

Validation:
- `countries.length >= 1`
- `disaster_types.length >= 1`
- `check_interval_minutes` in [5, 1440]

## 3. Event Data Model

```json
{
  "event_id": "hash(country+region+type+headline+date)",
  "country": "Pakistan",
  "subregion": "Sindh",
  "disaster_type": "flood",
  "severity": "high",
  "confidence": "medium",
  "summary": "River overflow warning expanded to ...",
  "impact": "Road closures in ...",
  "sources": [
    {"url": "https://...", "published_at": "2026-02-17T15:10:00Z", "source_type": "official"}
  ],
  "updated_at": "2026-02-17T15:15:00Z",
  "status": "new"
}
```

## 4. Monitoring Workflow
1. Load config/state.
2. Query source set by country/disaster filters.
3. Normalize candidates into event model.
4. Score severity and confidence.
5. Dedupe using hash + fuzzy match on summary/region/time.
6. Compare to last cycle (`new`, `updated`, `unchanged`).
7. Emit alerts by rule.
8. Persist cycle state and next check timestamp.

## 5. Alert Emission Rules
- Emit: all `high` and `critical`.
- Emit: `medium` only if `status` is `new` or meaningful `updated`.
- Skip: unchanged `medium`, most `low` items (store as watchlist only).

## 6. Storage and State
- Config path: `~/.config/moltis/moltis.toml`
- Key store: `~/.config/moltis/provider_keys.json`
- Data path: `~/.moltis/`
- Agent-specific state fields:
  - `last_cycle_hashes`
  - `last_run_at`
  - `last_summary`

## 7. Error Handling
- If source fetch fails: log source error, continue with remaining sources.
- If no reliable sources found: output "insufficient verification" with confidence `low`.
- If provider unavailable: skip cycle and retry next interval.

## 8. Security and Safety Controls
- No autonomous external actions.
- No emergency instructions without source attribution.
- Explicit warning for life-threatening situations.
- Prefer read-only operations where possible.

## 9. Observability
Per cycle capture:
- run start/end time
- sources queried and success/fail counts
- events generated by severity
- alerts emitted count
- deduped count

## 10. Open Technical Decisions
- Exact source connector strategy (RSS/APIs/scrape mix)
- Fuzzy-match threshold for near-duplicates
- Quiet-hours behavior for critical events (likely always notify)
